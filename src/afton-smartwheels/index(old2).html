<html>
<head>
  <style>
    .control-button {
      font-size: 24px;
      width: 50px;
      height: 50px;
    }
  </style>
</head>
<body onload="on_load();">
  <div id="connect">
    <input type="button" value="connect server" onclick="on_connect_server();">
    <input type="text" id="connect_input" name="connect_input" value="192.168.1.100">
  </div>
  <div id="controls" style="display:none;">
    <input type="button" class="control-button" value="&uarr;" onclick="send_move_command('MOV_FWD');">
    <input type="button" class="control-button" value="&#x23F8;" onclick="send_move_command('MOV_STOP');">
    <input type="button" class="control-button" value="&darr;" onclick="send_move_command('MOV_BACK');">
    
  </div>
  <div id="take">
    <input type="button" value="take picture" onclick="on_take_picture();">
    <input type="button" value="report to API" onclick="on_report_api();">
  </div>
  <div id="fail">
    Server connection fail.
  </div>
  <div>
    <canvas id="canvas_image" width="640" height="480"></canvas>
  </div>

  <script>
    var web_socket = null;

    function on_load() {
      document.getElementById('take').style.display = 'none';
      document.getElementById('fail').style.display = 'none';
      document.getElementById('controls').style.display = 'none';
    }

    function on_connect_server() {
      var text = document.getElementById('connect_input');
      var connection = "ws://" + text.value + ":80/ws";
      web_socket = new WebSocket(connection);
      web_socket.binaryType = 'arraybuffer';
      web_socket.onmessage = on_message;
      web_socket.onerror = on_error;
      document.getElementById('take').style.display = 'inline';
      document.getElementById('controls').style.display = 'inline';
      document.getElementById('connect').style.display = 'none';
    }

    function send_move_command(command) {
      var message = {
        command: command,
        steering: 0, // You can set these values dynamically if needed
        speed: 0
      };
      web_socket.send(JSON.stringify(message));
    }

    function on_take_picture() {
      var message = {
        command: "TAKE_IMG"
      };
      web_socket.send(JSON.stringify(message));
    }

    function on_report_api() {
      var message = {
        command: "SEND_IMG"
      };
      web_socket.send(JSON.stringify(message));
    }

    function on_error(recv_data) {
      document.getElementById('take').style.display = 'none';
      document.getElementById('controls').style.display = 'none';
      document.getElementById('fail').style.display = 'inline';
    }

    function on_message(recv_data) {
      var recv_image_data = new Uint8Array(recv_data.data);
      var canvas_image = document.getElementById('canvas_image');
      var ctx = canvas_image.getContext('2d');
      var image = new Image();
      image.src = 'data:image/jpeg;base64,' + recv_data.data;
      image.onload = function() {
        ctx.drawImage(image, 0, 0);
      }
    }
  </script>
</body>
</html>
