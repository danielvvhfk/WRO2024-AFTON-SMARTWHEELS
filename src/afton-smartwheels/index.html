<!DOCTYPE html>
<html>
<head>
  <style>
    .control-button {
      font-size: 24px;
      width: 50px;
      height: 50px;
    }
    #error-message {
      color: red;
      display: none;
    }
    .input-field {
      font-size: 24px;
      width: 100px;
    }
  </style>
</head>
<body onload="on_load();">
  <div id="connect">
    <input type="button" value="connect server" onclick="on_connect_server();">
    <input type="text" id="connect_input" name="connect_input" value="192.168.1.100">
  </div>
  <div id="controls" style="display:none;">
    <input type="button" class="control-button" value="&uarr;" onclick="send_move_command('MOV_FWD');">
    <input type="button" class="control-button" value="&#x23F8;" onclick="send_move_command('MOV_STOP');">
    <input type="button" class="control-button" value="&darr;" onclick="send_move_command('MOV_BACK');">

    <input type="text" id="speed_value" class="input-field" placeholder="Speed" value="100">
    <input type="text" id="steering_value" class="input-field" placeholder="Steering">
    <input type="button" value="send steering" onclick="send_steering();">

    <input type="button" value="Get Distance" onclick="send_get_distance_command();">
    <div id="distance_display">Distance: N/A</div>
  </div>
  <div id="take">
    <input type="button" value="take picture" onclick="on_take_picture();">
    <input type="button" value="report to API" onclick="on_report_api();">
  </div>
  <div id="fail" style="display:none;">
    Server connection fail.
  </div>
  <div id="error-message"></div>
  <div>
    <canvas id="canvas_image" width="640" height="480"></canvas>
  </div>

  <script>
    var web_socket = null;
    var reconnectInterval = 20; // Reconnect every 1 second
    var reconnectAttempts = 0;
    var maxReconnectAttempts = 10;
    var cmd = null;

    function on_load() {
      document.getElementById('take').style.display = 'none';
      document.getElementById('fail').style.display = 'none';
      document.getElementById('controls').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
    }

    function on_connect_server() {
      var text = document.getElementById('connect_input');
      var connection = "ws://" + text.value + ":80/ws";
      web_socket = new WebSocket(connection);
      web_socket.binaryType = 'arraybuffer';
      web_socket.onopen = function() {
        console.log("WebSocket connection opened");
        document.getElementById('take').style.display = 'inline';
        document.getElementById('controls').style.display = 'inline';
        document.getElementById('connect').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';
        reconnectAttempts = 0; // Reset reconnect attempts on successful connection
      };
      web_socket.onmessage = on_message;
      web_socket.onerror = on_error;
    }

    function send_move_command(command) {
      cmd = command; // Set the local variable cmd before sending the command

      var speed = parseInt(document.getElementById('speed_value').value);
      if (isNaN(speed) || speed < 0 || speed > 100) {
        speed = 100; // Default speed
      }

      var message = {
        command: command,
        steering: 0, // You can set these values dynamically if needed
        speed: speed
      };
      // console.log("Sending command: ", message);
      web_socket.send(JSON.stringify(message));

      // reconnect_websocket();
      // var message = {
      //   command: 'MOV_STOP',
      //   steering: 0, // You can set these values dynamically if needed
      //   speed: speed
      // };
      // // console.log("Sending command: ", message);
      // web_socket.send(JSON.stringify(message));

    }

    function send_steering_command(command, pos) {
      cmd = command; // Set the local variable cmd before sending the command

      var message = {
        command: command,
        steering: pos, // You can set these values dynamically if needed
        speed: 0
      };
      // console.log("Sending command: ", message);
      web_socket.send(JSON.stringify(message));
    }

    function send_steering() {
      var pos = parseInt(document.getElementById('steering_value').value);
      if (!isNaN(pos)) {
        send_steering_command('SW', pos);
      } else {
        console.error("Invalid steering value");
      }
    }

    function on_take_picture() {
      cmd = "TAKE_IMG"; // Set the local variable cmd before sending the command

      var message = {
        command: "TAKE_IMG"
      };
      // console.log("Sending command: ", message);
      web_socket.send(JSON.stringify(message));
    }

    function on_report_api() {
      cmd = "SEND_IMG"; // Set the local variable cmd before sending the command

      var message = {
        command: "SEND_IMG"
      };
      // console.log("Sending command: ", message);
      web_socket.send(JSON.stringify(message));
    }

    function send_get_distance_command() {
      cmd = "GET_DIST"; // Set the local variable cmd before sending the command

      var message = {
        command: "GET_DIST"
      };
      console.log("Sending command: ", message);
      web_socket.send(JSON.stringify(message));
    }

    function on_error(event) {
      // console.error("WebSocket error: ", event);
      // display_error("WebSocket error: " + event.message);
      reconnect_websocket();
    }


    function on_message(event) {
      try {
        if (cmd === "SEND_IMG" || cmd === "TAKE_IMG") {
          var recv_image_data = new Uint8Array(event.data);
          var canvas_image = document.getElementById('canvas_image');
          var ctx = canvas_image.getContext('2d');
          var image = new Image();
          image.src = 'data:image/jpeg;base64,' + event.data;
          image.onload = function() {
            ctx.drawImage(image, 0, 0);
          };
        } else if (cmd === "GET_DIST") {
          var distance = JSON.parse(event.data).distance;
          document.getElementById('distance_display').innerText = "Distance: " + distance + " mm";
        } else {
          console.log("Command executed: ", message.command);
        }
      } catch (e) {
        console.error("Failed to parse message: ", e);
      }
    }

    function reconnect_websocket() {
      if (reconnectAttempts < maxReconnectAttempts) {
        setTimeout(function() {
          console.log("Reconnecting WebSocket attempt " + reconnectAttempts);
          on_connect_server();
          reconnectAttempts++;
        }, reconnectInterval);
      } else {
        console.error("Max reconnect attempts reached");
        display_error("Max reconnect attempts reached. Please reload the page.");
      }
    }

    function display_error(message) {
      var errorMessage = document.getElementById('error-message');
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    window.onerror = function(message, source, lineno, colno, error) {
      console.error("Global error handler: ", message, source, lineno, colno, error);
      display_error("Global error: " + message + " at " + source + ":" + lineno + ":" + colno);
    }
  </script>
</body>
</html>
